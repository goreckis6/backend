name: Deploy Backend

on:
  push:
    branches: [main]

permissions:
  contents: read
  packages: write

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Test SSH Connection
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.BACKEND_VPS_HOST }}
        username: ${{ secrets.BACKEND_VPS_USERNAME }}
        key: ${{ secrets.BACKEND_VPS_SSH_KEY }}
        script: |
          echo "âœ… Testing SSH connection..."
          hostname
          whoami
          uptime
          echo "âœ… SSH connection successful!"

    - name: Deploy to VPS
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.BACKEND_VPS_HOST }}
        username: ${{ secrets.BACKEND_VPS_USERNAME }}
        key: ${{ secrets.BACKEND_VPS_SSH_KEY }}
        script: |
          set -euo pipefail
          
          echo "ğŸš€ Starting deployment..."
          
          # Define paths
          BACKEND_DIR="/opt/backend"
          VENV_DIR="/opt/venv"
          
          # Navigate to backend directory
          cd $BACKEND_DIR
          
          # Pull latest changes
          echo "ğŸ“¥ Pulling latest changes from GitHub..."
          git fetch origin main
          git reset --hard origin/main
          git clean -fd
          
          # Clear Node.js cache and old builds
          echo "ğŸ§¹ Cleaning cache and old builds..."
          rm -rf node_modules/.cache
          rm -rf dist
          rm -rf .npm
          npm cache clean --force
          
          # Install/Update Node.js dependencies (fresh install)
          echo "ğŸ“¦ Installing Node.js dependencies..."
          npm ci --production=false
          
          # Build application
          echo "ğŸ”¨ Building application..."
          npm run build
          
          # Ensure scripts directory exists and copy Python scripts
          echo "ğŸ“ Setting up Python scripts directory..."
          mkdir -p $BACKEND_DIR/scripts
          rsync -av --delete scripts/ $BACKEND_DIR/scripts/ 2>/dev/null || echo "âš ï¸ No scripts directory found, creating empty one"
          
          # Ensure viewers directory exists and copy viewer scripts
          echo "ğŸ“ Setting up viewers directory..."
          mkdir -p $BACKEND_DIR/viewers
          rsync -av --delete viewers/ $BACKEND_DIR/viewers/ 2>/dev/null || echo "âš ï¸ No viewers directory found, creating empty one"
          
          # Verify scripts are in place
          echo "ğŸ” Verifying Python scripts..."
          REQUIRED_SCRIPTS=(
            "csv_to_odp.py"
            "cr2_to_ico.py"
            "cr2_to_webp.py"
            "csv_to_doc.py"
            "csv_to_doc_optimized.py"
            "csv_to_docx.py"
            "csv_to_docx_optimized.py"
            "csv_to_epub.py"
            "csv_to_html.py"
            "csv_to_md.py"
            "csv_to_mobi.py"
          )
          
          for script in "${REQUIRED_SCRIPTS[@]}"; do
            if [ -f "$BACKEND_DIR/scripts/$script" ]; then
              echo "âœ… $script found in $BACKEND_DIR/scripts/"
            else
              echo "âŒ ERROR: $script not found in $BACKEND_DIR/scripts/"
            fi
          done
          
          echo "ğŸ“‹ All available files in scripts directory:"
          ls -la $BACKEND_DIR/scripts/ || echo "Scripts directory does not exist"
          
          # Check if any required scripts are missing
          MISSING_SCRIPTS=()
          for script in "${REQUIRED_SCRIPTS[@]}"; do
            if [ ! -f "$BACKEND_DIR/scripts/$script" ]; then
              MISSING_SCRIPTS+=("$script")
            fi
          done
          
          if [ ${#MISSING_SCRIPTS[@]} -gt 0 ]; then
            echo "âŒ CRITICAL ERROR: Missing required scripts: ${MISSING_SCRIPTS[*]}"
            echo "ğŸ”§ Attempting to copy scripts again..."
            rsync -av --delete scripts/ $BACKEND_DIR/scripts/ || echo "âš ï¸ Failed to copy scripts again"
            exit 1
          fi
          
          # Setup Python environment (only if not exists or needs update)
          if [ ! -d "$VENV_DIR" ] || [ ! -f "$VENV_DIR/bin/python" ]; then
            echo "ğŸ Setting up Python virtual environment..."
            
            # Install system dependencies
            sudo apt update -qq
            sudo apt install -y \
              python3 python3-pip python3-venv python3-dev \
              libjpeg-dev libpng-dev libtiff-dev libraw-dev \
              build-essential libffi-dev
            
            # Create virtual environment
            sudo mkdir -p $VENV_DIR
            sudo chown -R debian:debian $VENV_DIR
            python3 -m venv $VENV_DIR
            
            # Install Python packages
            $VENV_DIR/bin/pip install --upgrade pip
            $VENV_DIR/bin/pip install Pillow rawpy odfpy
          else
            echo "âœ… Python environment already exists, skipping setup..."
          fi
          
          # Verify Python environment
          echo "ğŸ” Verifying Python environment..."
          $VENV_DIR/bin/python --version
          if $VENV_DIR/bin/python -c "import rawpy, PIL, odfpy; print('âœ… Python packages OK')"; then
            echo "âœ… Python environment verified successfully"
          else
            echo "âš ï¸ Warning: Python packages verification failed"
            # Reinstall packages
            $VENV_DIR/bin/pip install --upgrade --force-reinstall Pillow rawpy odfpy
          fi
          
          # Clear PM2 logs and dump before restart
          echo "ğŸ§¹ Clearing PM2 logs and cache..."
          pm2 flush  # Clear all logs
          pm2 cleardump  # Clear PM2 dump file
          
          # Stop PM2 process completely (not reload)
          echo "â¹ï¸ Stopping PM2 process..."
          pm2 stop morphy-backend 2>/dev/null || true
          pm2 delete morphy-backend 2>/dev/null || true
          
                 # Start fresh PM2 process
                 echo "â–¶ï¸ Starting fresh PM2 process..."
                 cd $BACKEND_DIR
                 pm2 start ecosystem.config.cjs
                 pm2 save --force
          
          # Restart Traefik with force-recreate
          echo "ğŸ”„ Restarting Traefik..."
          docker compose -f traefik-only.yml down
          docker compose -f traefik-only.yml pull
          docker compose -f traefik-only.yml up -d --force-recreate --remove-orphans
          
          # Wait for services to be ready
          echo "â³ Waiting for services to start..."
          sleep 5
          
          # Health checks
          echo "ğŸ¥ Running health checks..."
          
          # Check if backend is running on localhost
          if curl -f -s http://localhost:3000/health > /dev/null; then
            echo "âœ… Backend is running on localhost:3000"
          else
            echo "âŒ ERROR: Backend not accessible on localhost:3000"
            pm2 logs morphy-backend --lines 50 --nostream
            exit 1
          fi
          
          # Check if Traefik routing is working
          if curl -f -s https://api.morphyimg.com/health > /dev/null; then
            echo "âœ… Traefik routing is working (https://api.morphyimg.com)"
          else
            echo "âš ï¸ WARNING: Traefik routing may not be working yet (allow 30s for SSL)"
          fi
          
                 # Check Python environment in running app
                 echo "ğŸ Testing Python in running application..."
                 if $VENV_DIR/bin/python -c "import rawpy; print('âœ… rawpy OK')" 2>/dev/null; then
                   echo "âœ… rawpy is working"
                 else
                   echo "âš ï¸ WARNING: rawpy may not be working"
                 fi

                 if $VENV_DIR/bin/python -c "import PIL; print('âœ… Pillow OK')" 2>/dev/null; then
                   echo "âœ… Pillow is working"
                 else
                   echo "âš ï¸ WARNING: Pillow may not be working"
                 fi

                 if $VENV_DIR/bin/python -c "import odfpy; print('âœ… odfpy OK')" 2>/dev/null; then
                   echo "âœ… odfpy is working"
                 else
                   echo "âš ï¸ WARNING: odfpy may not be working"
                 fi
                 
                 # Verify script paths are accessible
                 echo "ğŸ“ Verifying script paths..."
                 for script in "${REQUIRED_SCRIPTS[@]}"; do
                   if [ -f "$BACKEND_DIR/scripts/$script" ]; then
                     echo "âœ… $BACKEND_DIR/scripts/$script is accessible"
                     # Test if script can be executed (check syntax)
                     if $VENV_DIR/bin/python -m py_compile "$BACKEND_DIR/scripts/$script" 2>/dev/null; then
                       echo "âœ… $script syntax is valid"
                     else
                       echo "âš ï¸ WARNING: $script has syntax errors"
                     fi
                   else
                     echo "âŒ ERROR: $BACKEND_DIR/scripts/$script not accessible"
                   fi
                 done
                 
                 # Show status
          echo ""
          echo "ğŸ“Š Deployment Status:"
          echo "===================="
          pm2 status
          echo ""
          docker compose -f traefik-only.yml ps
          echo ""
          echo "âœ… Deployment completed successfully!"
          echo "ğŸŒ API: https://api.morphyimg.com"
          echo "ğŸ¥ Health: https://api.morphyimg.com/health"

    - name: Verify Deployment
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.BACKEND_VPS_HOST }}
        username: ${{ secrets.BACKEND_VPS_USERNAME }}
        key: ${{ secrets.BACKEND_VPS_SSH_KEY }}
        script: |
          echo "ğŸ” Final verification after 10 seconds..."
          sleep 10
          
          # Test health endpoint
          if curl -f -s https://api.morphyimg.com/health | grep -q "healthy"; then
            echo "âœ… Deployment verified: API is healthy"
          else
            echo "Testing health endpoint..."
            HEALTH_RESPONSE=$(curl -f -s https://api.morphyimg.com/health 2>&1)
            CURL_EXIT_CODE=$?
            
            if [ $CURL_EXIT_CODE -eq 0 ]; then
              echo "âœ… Deployment verified: API is responding"
              echo "ğŸ“‹ Health response: $HEALTH_RESPONSE"
            else
              echo "âŒ Deployment verification failed"
              exit 1
            fi
          fi

    - name: Show Logs on Failure
      if: failure()
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.BACKEND_VPS_HOST }}
        username: ${{ secrets.BACKEND_VPS_USERNAME }}
        key: ${{ secrets.BACKEND_VPS_SSH_KEY }}
        script: |
          echo "âŒ Deployment failed! Checking logs..."
          echo ""
          echo "ğŸ“‹ PM2 Logs:"
          pm2 logs morphy-backend --lines 100 --nostream
          echo ""
          echo "ğŸ“Š PM2 Status:"
          pm2 status
          echo ""
          echo "ğŸ³ Docker Status:"
          docker compose -f traefik-only.yml ps
          echo ""
          echo "ğŸ” Port 3000 Status:"
          netstat -tlnp | grep :3000 || echo "Port 3000 not listening"