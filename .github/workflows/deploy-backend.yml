name: Deploy Backend

on:
  push:
    branches: [main]
  workflow_dispatch:

permissions:
  contents: read
  packages: write

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Test SSH Connection
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.BACKEND_VPS_HOST }}
          username: ${{ secrets.BACKEND_VPS_USERNAME }}
          key: ${{ secrets.BACKEND_VPS_SSH_KEY }}
          script: |
            echo "‚úÖ Testing SSH connection..."
            hostname
            whoami
            uptime
            echo "‚úÖ SSH connection successful!"

      - name: Deploy to VPS
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.BACKEND_VPS_HOST }}
          username: ${{ secrets.BACKEND_VPS_USERNAME }}
          key: ${{ secrets.BACKEND_VPS_SSH_KEY }}
          script: |
            set -euo pipefail
            
            echo "üöÄ Starting deployment..."
            
            # Define paths
            BACKEND_DIR="/opt/backend"
            VENV_DIR="/opt/venv"
            
            # Navigate to backend directory
            cd $BACKEND_DIR
            
            # Pull latest changes
            echo "üì• Pulling latest changes from GitHub..."
            git fetch origin main
            git reset --hard origin/main
            git clean -fd
            
            # Install/Update Node.js dependencies
            echo "üì¶ Installing Node.js dependencies..."
            npm ci --production=false
            
            # Build application
            echo "üî® Building application..."
            npm run build
            
            # Setup Python environment (only if not exists or needs update)
            if [ ! -d "$VENV_DIR" ] || [ ! -f "$VENV_DIR/bin/python" ]; then
              echo "üêç Setting up Python virtual environment..."
              
              # Install system dependencies
              sudo apt update -qq
              sudo apt install -y \
                python3 python3-pip python3-venv python3-dev \
                libjpeg-dev libpng-dev libtiff-dev libraw-dev \
                build-essential libffi-dev
              
              # Create virtual environment
              sudo mkdir -p $VENV_DIR
              sudo chown -R debian:debian $VENV_DIR
              python3 -m venv $VENV_DIR
              
              # Install Python packages
              $VENV_DIR/bin/pip install --upgrade pip
              $VENV_DIR/bin/pip install Pillow rawpy
            else
              echo "‚úÖ Python environment already exists, skipping setup..."
            fi
            
            # Verify Python environment
            echo "üîç Verifying Python environment..."
            $VENV_DIR/bin/python --version
            if $VENV_DIR/bin/python -c "import rawpy, PIL; print('‚úÖ Python packages OK')"; then
              echo "‚úÖ Python environment verified successfully"
            else
              echo "‚ö†Ô∏è Warning: Python packages verification failed"
              # Reinstall packages
              $VENV_DIR/bin/pip install --upgrade --force-reinstall Pillow rawpy
            fi
            
            # Restart PM2 process
            echo "üîÑ Restarting PM2 process..."
            pm2 reload ecosystem.config.cjs --update-env || pm2 start ecosystem.config.cjs
            pm2 save
            
            # Restart Traefik (ensure latest routing)
            echo "üîÑ Restarting Traefik..."
            docker compose -f traefik-only.yml down
            docker compose -f traefik-only.yml up -d --remove-orphans
            
            # Wait for services to be ready
            echo "‚è≥ Waiting for services to start..."
            sleep 5
            
            # Health checks
            echo "üè• Running health checks..."
            
            # Check if backend is running on localhost
            if curl -f -s http://localhost:3000/health > /dev/null; then
              echo "‚úÖ Backend is running on localhost:3000"
            else
              echo "‚ùå ERROR: Backend not accessible on localhost:3000"
              pm2 logs morphy-backend --lines 50 --nostream
              exit 1
            fi
            
            # Check if Traefik routing is working
            if curl -f -s https://api.morphyimg.com/health > /dev/null; then
              echo "‚úÖ Traefik routing is working (https://api.morphyimg.com)"
            else
              echo "‚ö†Ô∏è WARNING: Traefik routing may not be working yet (allow 30s for SSL)"
            fi
            
            # Check Python environment in running app
            echo "üêç Testing Python in running application..."
            if $VENV_DIR/bin/python -c "import rawpy; print('‚úÖ rawpy OK')" 2>/dev/null; then
              echo "‚úÖ rawpy is working"
            else
              echo "‚ö†Ô∏è WARNING: rawpy may not be working"
            fi
            
            if $VENV_DIR/bin/python -c "import PIL; print('‚úÖ Pillow OK')" 2>/dev/null; then
              echo "‚úÖ Pillow is working"
            else
              echo "‚ö†Ô∏è WARNING: Pillow may not be working"
            fi
            
            # Show status
            echo ""
            echo "üìä Deployment Status:"
            echo "===================="
            pm2 status
            echo ""
            docker compose -f traefik-only.yml ps
            echo ""
            echo "‚úÖ Deployment completed successfully!"
            echo "üåê API: https://api.morphyimg.com"
            echo "üè• Health: https://api.morphyimg.com/health"

      - name: Verify Deployment
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.BACKEND_VPS_HOST }}
          username: ${{ secrets.BACKEND_VPS_USERNAME }}
          key: ${{ secrets.BACKEND_VPS_SSH_KEY }}
          script: |
            echo "üîç Final verification after 10 seconds..."
            sleep 10
            
            # Test health endpoint
            if curl -f -s https://api.morphyimg.com/health | grep -q "healthy"; then
              echo "‚úÖ Deployment verified: API is healthy"
            else
              echo "‚ùå Deployment verification failed"
              exit 1
            fi

      - name: Notify on Failure
        if: failure()
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.BACKEND_VPS_HOST }}
          username: ${{ secrets.BACKEND_VPS_USERNAME }}
          key: ${{ secrets.BACKEND_VPS_SSH_KEY }}
          script: |
            echo "‚ùå Deployment failed! Checking logs..."
            pm2 logs morphy-backend --lines 100 --nostream
            pm2 status
