name: Deploy Backend

on:
  push:
    branches: [main]
  workflow_dispatch:

permissions:
  contents: read
  packages: write

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Test SSH Connection
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.BACKEND_VPS_HOST }}
          username: ${{ secrets.BACKEND_VPS_USERNAME }}
          key: ${{ secrets.BACKEND_VPS_SSH_KEY }}
          script: |
            echo "âœ… Testing SSH connection..."
            hostname
            whoami
            uptime
            echo "âœ… SSH connection successful!"

      - name: Deploy to VPS
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.BACKEND_VPS_HOST }}
          username: ${{ secrets.BACKEND_VPS_USERNAME }}
          key: ${{ secrets.BACKEND_VPS_SSH_KEY }}
          script: |
            set -euo pipefail
            
            echo "ğŸš€ Starting deployment..."
            
            # Define paths
            BACKEND_DIR="/opt/backend"
            VENV_DIR="/opt/venv"
            
            # Navigate to backend directory
            cd $BACKEND_DIR
            
            # Pull latest changes
            echo "ğŸ“¥ Pulling latest changes from GitHub..."
            git fetch origin main
            git reset --hard origin/main
            git clean -fd
            
            # Clear Node.js cache and old builds
            echo "ğŸ§¹ Cleaning cache and old builds..."
            rm -rf node_modules/.cache
            rm -rf dist
            rm -rf .npm
            npm cache clean --force
            
            # Install/Update Node.js dependencies (fresh install)
            echo "ğŸ“¦ Installing Node.js dependencies..."
            npm ci --production=false
            
            # Build application
            echo "ğŸ”¨ Building application..."
            npm run build
            
            # Setup Python environment (only if not exists or needs update)
            if [ ! -d "$VENV_DIR" ] || [ ! -f "$VENV_DIR/bin/python" ]; then
              echo "ğŸ Setting up Python virtual environment..."
              
              # Install system dependencies
              sudo apt update -qq
              sudo apt install -y \
                python3 python3-pip python3-venv python3-dev \
                libjpeg-dev libpng-dev libtiff-dev libraw-dev \
                build-essential libffi-dev
              
              # Create virtual environment
              sudo mkdir -p $VENV_DIR
              sudo chown -R debian:debian $VENV_DIR
              python3 -m venv $VENV_DIR
              
              # Install Python packages
              $VENV_DIR/bin/pip install --upgrade pip
              $VENV_DIR/bin/pip install Pillow rawpy pandas python-docx openpyxl xlsxwriter
            else
              echo "âœ… Python environment already exists, skipping setup..."
            fi
            
            # Verify Python environment
            echo "ğŸ” Verifying Python environment..."
            $VENV_DIR/bin/python --version
            if $VENV_DIR/bin/python -c "import rawpy, PIL, pandas, docx; print('âœ… Python packages OK')"; then
              echo "âœ… Python environment verified successfully"
            else
              echo "âš ï¸ Warning: Python packages verification failed"
              # Reinstall packages
              $VENV_DIR/bin/pip install --upgrade --force-reinstall Pillow rawpy pandas python-docx openpyxl xlsxwriter
            fi
            
            # Clear PM2 logs and dump before restart
            echo "ğŸ§¹ Clearing PM2 logs and cache..."
            pm2 flush  # Clear all logs
            pm2 cleardump  # Clear PM2 dump file
            
            # Stop PM2 process completely (not reload)
            echo "â¹ï¸ Stopping PM2 process..."
            pm2 stop morphy-backend 2>/dev/null || true
            pm2 delete morphy-backend 2>/dev/null || true
            
            # Start fresh PM2 process
            echo "â–¶ï¸ Starting fresh PM2 process..."
            pm2 start ecosystem.config.cjs
            pm2 save --force
            
            # Restart Traefik with force-recreate
            echo "ğŸ”„ Restarting Traefik..."
            docker compose -f traefik-only.yml down
            docker compose -f traefik-only.yml pull
            docker compose -f traefik-only.yml up -d --force-recreate --remove-orphans
            
            # Wait for services to be ready
            echo "â³ Waiting for services to start..."
            sleep 5
            
            # Health checks
            echo "ğŸ¥ Running health checks..."
            
            # Check if backend is running on localhost
            if curl -f -s http://localhost:3000/health > /dev/null; then
              echo "âœ… Backend is running on localhost:3000"
            else
              echo "âŒ ERROR: Backend not accessible on localhost:3000"
              pm2 logs morphy-backend --lines 50 --nostream
              exit 1
            fi
            
            # Check if Traefik routing is working
            if curl -f -s https://api.morphyimg.com/health > /dev/null; then
              echo "âœ… Traefik routing is working (https://api.morphyimg.com)"
            else
              echo "âš ï¸ WARNING: Traefik routing may not be working yet (allow 30s for SSL)"
            fi
            
            # Check Python environment in running app
            echo "ğŸ Testing Python in running application..."
            if $VENV_DIR/bin/python -c "import rawpy; print('âœ… rawpy OK')" 2>/dev/null; then
              echo "âœ… rawpy is working"
            else
              echo "âš ï¸ WARNING: rawpy may not be working"
            fi
            
            if $VENV_DIR/bin/python -c "import PIL; print('âœ… Pillow OK')" 2>/dev/null; then
              echo "âœ… Pillow is working"
            else
              echo "âš ï¸ WARNING: Pillow may not be working"
            fi
            
            # Show status
            echo ""
            echo "ğŸ“Š Deployment Status:"
            echo "===================="
            pm2 status
            echo ""
            docker compose -f traefik-only.yml ps
            echo ""
            echo "âœ… Deployment completed successfully!"
            echo "ğŸŒ API: https://api.morphyimg.com"
            echo "ğŸ¥ Health: https://api.morphyimg.com/health"

      - name: Verify Deployment
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.BACKEND_VPS_HOST }}
          username: ${{ secrets.BACKEND_VPS_USERNAME }}
          key: ${{ secrets.BACKEND_VPS_SSH_KEY }}
          script: |
            echo "ğŸ” Final verification after 10 seconds..."
            sleep 10
            
            # Test health endpoint
            echo "Testing health endpoint..."
            HEALTH_RESPONSE=$(curl -f -s https://api.morphyimg.com/health 2>&1)
            CURL_EXIT_CODE=$?
            
            if [ $CURL_EXIT_CODE -eq 0 ]; then
              echo "âœ… Deployment verified: API is responding"
              echo "ğŸ“‹ Health response: $HEALTH_RESPONSE"
            else
              echo "âš ï¸ External endpoint not ready yet (this is normal)"
              echo "ğŸ“‹ Response: $HEALTH_RESPONSE"
              echo "ğŸ” Checking localhost..."
              if curl -s http://localhost:3000/health > /dev/null; then
                echo "âœ… Backend is running on localhost (Traefik may need more time for SSL)"
              else
                echo "âŒ Backend not responding on localhost either"
                exit 1
              fi
            fi

      - name: Show Logs on Failure
        if: failure()
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.BACKEND_VPS_HOST }}
          username: ${{ secrets.BACKEND_VPS_USERNAME }}
          key: ${{ secrets.BACKEND_VPS_SSH_KEY }}
          script: |
            echo "âŒ Deployment failed! Checking logs..."
            echo ""
            echo "ğŸ“‹ PM2 Logs:"
            pm2 logs morphy-backend --lines 100 --nostream
            echo ""
            echo "ğŸ“Š PM2 Status:"
            pm2 status
            echo ""
            echo "ğŸ³ Docker Status:"
            docker compose -f traefik-only.yml ps
            echo ""
            echo "ğŸ” Port 3000 Status:"
            netstat -tlnp | grep :3000 || echo "Port 3000 not listening"
